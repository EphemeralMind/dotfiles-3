#!/bin/bash

dot="·"
dash="-"
mult="×"
plus="+"

# Create the fifo, if it doesn't already exist
[ -p "$PANEL_FIFO" ] || mkfifo "$PANEL_FIFO";


# ========================================
# Output to the fifo
# ========================================

# BSPWM workspaces
bspc subscribe report > "$PANEL_FIFO" &

# Window title
xtitle -sf 'T%s\n' > "$PANEL_FIFO" &

# Time
while true
do
	date "+C%H:%M"
	sleep 1
done > "$PANEL_FIFO" &

# Battery status

# Get battery name
BATN=$(ls /sys/class/power_supply/ | grep BAT)
if [ -n "$BATN" ] && [ -x "$(command -v getcolor.sh)" ]
then
	while true
	do
		echo "B$(battery.sh)"
		sleep 30
	done > "$PANEL_FIFO" &
fi

# ========================================
# Parse the output of the fifo
# ========================================

num_mon=$(bspc query -M | wc -l)

padding=6
BG="#$(getcolor.sh bg)"
FG="#$(getcolor.sh fg)"
col0="#$(getcolor.sh 0)"
col1="#$(getcolor.sh 1)"
col2="#$(getcolor.sh 2)"
col3="#$(getcolor.sh 3)"
col4="#$(getcolor.sh 4)"
col5="#$(getcolor.sh 5)"
col6="#$(getcolor.sh 6)"
col7="#$(getcolor.sh 7)"
col8="#$(getcolor.sh 8)"
col9="#$(getcolor.sh 9)"
col10="#$(getcolor.sh 10)"
col11="#$(getcolor.sh 11)"
col12="#$(getcolor.sh 12)"
col13="#$(getcolor.sh 13)"
col14="#$(getcolor.sh 14)"
col15="#$(getcolor.sh 15)"

gap=$(bspc config window_gap)
monwidth=$(xrandr | grep \* | awk '{print $1}' | cut -d 'x' -f 1)
width=$((monwidth - 2 * gap))
geometry="${width}x${PANEL_HEIGHT}+${gap}+"

while read -r line
do
	case $line in
		B*)
			bat=""
			bat+="%{B${BG}}"
			bat+="%{F${FG}}"
			bat+="${line#?}"
			bat+="%{B-}"
			bat+="%{F-}"
			;;
		C*)
			clock=""
			clock+="%{B${col2}}"
			clock+="%{F${col0}}"
			clock+=" "
			clock+="\ue015" # Clock icon
			clock+=" "
			clock+="%{B${col15}}"
			clock+=" "
			clock+=${line#?}
			clock+=" "
			clock+="%{B-}"
			clock+="%{F-}"
			;;
		W*)
			# bspwm's state
			wm=
			IFS=':'
			set -- ${line#?}
			while [ $# -gt 0 ]
			do
				item=$1
				name=${item#?}
				case $item in
					[mM]*)
						# Monitors
						case $item in
							m*)
								# Monitor
								FG=${col7}
								;;
							M*)
								# Focused monitor
								FG=${col15}
								;;
						esac
						[ $num_mon -lt 2 ] && shift && continue
						wm="${wm}%{A:bspc monitor -f ${name}:} ${name} %{A}"
						;;
					[fFoOuU]*)
						# Desktops
						case $item in
							[FOU]*)
								icon="+"
								;;
							f*)
								# free desktop
								icon=${dot}
								;;
							F*)
								# free active/focused desktop
								icon=${dot}
								;;
							o*)
								# occupied desktop
								icon=${dash}
								;;
							O*)
								# occupied active/focused desktop
								icon=${dash}
								;;
							u*)
								# urgent desktop
								FG=${col4}
								;;
							U*)
								# urgent active/focused desktop
								FG=${col4}
								;;
						esac
						wm="${wm}%{F${FG}}%{B${BG}} ${icon} %{F-}%{B-}"
						;;
					[LTG]*)
						# Layout, state, and flags
						# TODO: display these
						;;
				esac
				shift
			done
			;;
		T*)
			title=${line#?}
			focused=$(xprop -root _NET_ACTIVE_WINDOW | cut -d ' ' -f 5)
			name=$(xprop -id ${focused} WM_NAME 2>/dev/null | sed -nr 's/.*= "(.*)"$/\1/p')
			name=$(echo $name | awk -v len=40 '{ if (length($0) > len) print substr($0, 1, len-3) "..."; else print; }')
			class=$(xprop -id ${focused} WM_CLASS 2>/dev/null | awk -F '"' '{print $4}')
			title="%{F${FG}}%{B${BG}} ${class} %{F#$(getcolor.sh 8)}${name} %{F-}%{B-}"
			title=""
			title+="%{F${col0}}"
			title+="%{B${col3}}"
			title+=" "
			title+="${class}"
			title+=" "
			title+="%{B${col15}}"
			title+=" "
			title+="${name}"
			title+=" "
			title+="%{B-}"
			title+="%{F-}"
			;;
	esac
	echo -e  "%{l}${wm}${title}%{r}${bat}${clock}"
done < "$PANEL_FIFO" | lemonbar \
	-B "#$(getcolor.sh bg)" \
	-F "#$(getcolor.sh fg)" \
	-f "$PANEL_FONT" \
	-f "$PANEL_ICON_FONT" \
	-n "$PANEL_WM_NAME" \
	-g "$geometry" \
